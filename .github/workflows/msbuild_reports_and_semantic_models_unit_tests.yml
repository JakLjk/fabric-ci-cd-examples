name: Build Datasets and Reports

on:
  # Equivalent to `trigger: none` in Azure DevOps â€“ manual only
  workflow_dispatch:

jobs:
  build_datasets:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download Tabular Editor and Default Rules
        run: |
          $path = "$env:GITHUB_WORKSPACE"
          $tempPath = "$path\_temp"
          $toolPath = "$path\_tools\TE"
          New-Item -ItemType Directory -Path $tempPath -ErrorAction SilentlyContinue | Out-Null              

          Write-Host "##[debug]Downloading Tabular Editor binaries"
          $downloadUrl = "https://github.com/TabularEditor/TabularEditor/releases/latest/download/TabularEditor.Portable.zip"
          $zipFile = "$tempPath\TabularEditor.zip"
          Invoke-WebRequest -Uri $downloadUrl -OutFile $zipFile
          Expand-Archive -Path $zipFile -DestinationPath $toolPath -Force            

          Write-Host "##[debug]Downloading Dataset default rules"
          $downloadUrl = "https://raw.githubusercontent.com/microsoft/Analysis-Services/master/BestPracticeRules/BPARules.json"
          Invoke-WebRequest -Uri $downloadUrl -OutFile "$tempPath\Rules-Dataset.json"

      - name: Run Dataset Rules
        run: |
          $path = "$env:GITHUB_WORKSPACE"
          $tempPath = "$path\_temp"
          $toolPath = "$path\_Tools\TE\TabularEditor.exe"
          $rulesPath = "$path\Rules-Dataset.json"

          if (!(Test-Path $rulesPath))
          {
              Write-Host "Running downloaded rules"
              $rulesPath = "$tempPath\Rules-Dataset.json"
          }

          $itemsFolders = Get-ChildItem  -Path $path -Recurse -Include ("*.pbidataset", "*.pbism")

          foreach($itemFolder in $itemsFolders)
          {	
              $itemPath = "$($itemFolder.Directory.FullName)\definition"

              if (!(Test-Path $itemPath))
              {
                  $itemPath = "$($itemFolder.Directory.FullName)\model.bim"

                  if (!(Test-Path $itemPath))
                  {
                      throw "Cannot find semantic model definition."
                  }

              }

              Write-Host "##[group]Running rules for: '$itemPath'"

              Start-Process -FilePath "$toolPath" -ArgumentList """$itemPath"" -A ""$rulesPath"" -V" -NoNewWindow -Wait

              Write-Host "##[endgroup]"
          }

  build_reports:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download PBIXInspector
        run: |
          $path = "$env:GITHUB_WORKSPACE"
          $tempPath = "$path\_temp"
          $toolPath = "$path\_Tools\PBIInspector"
          New-Item -ItemType Directory -Path $tempPath -ErrorAction SilentlyContinue | Out-Null

          Write-Host "##[debug]Downloading PBI Inspector"
          $downloadUrl = "https://github.com/NatVanG/PBI-Inspector/releases/latest/download/win-x64-CLI.zip" 
          $zipFile = "$tempPath\PBIXInspector.zip"
          Invoke-WebRequest -Uri $downloadUrl -OutFile $zipFile
          Expand-Archive -Path $zipFile -DestinationPath $toolPath -Force                            

          Write-Host "##[debug]Downloading Report default rules"
          $downloadUrl = "https://raw.githubusercontent.com/NatVanG/PBI-Inspector/main/Rules/Base-rules.json"
          Invoke-WebRequest -Uri $downloadUrl -OutFile "$tempPath\Rules-Report.json"

      - name: Run Report Rules
        run: |
          $path = "$env:GITHUB_WORKSPACE"
          $tempPath = "$path\_temp"
          $toolPath =  "$path\_Tools\PBIInspector\win-x64\CLI\PBIXInspectorCLI.exe"
          $rulesPath = "$path\Rules-Report.json"

          if (!(Test-Path $rulesPath))
          {
              Write-Host "Running default downloaded rules"
              $rulesPath = "$tempPath\Rules-Report.json"
          }

          $itemsFolders = Get-ChildItem  -Path $path -Recurse -Include *.pbir

          foreach($itemFolder in $itemsFolders)
          {	
              $itemPath = $itemFolder.Directory.FullName
              
              Write-Host "##[group]Running rules for: '$itemPath'"

              Start-Process -FilePath "$toolPath" -ArgumentList "-pbipreport ""$itemPath"" -rules ""$rulesPath"" -formats ""ADO""" -NoNewWindow -Wait
              
              Write-Host "##[endgroup]"
          }
